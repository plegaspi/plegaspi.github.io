NEG.Module("Biz.Product.ProductPersonalization", function (require) {var $ = jQuery;var _option = {singleItemSelector: '#buying-combo-3',comboItemSelector: "#buying-combo-2",personalizationSelector: "#buying-combo",mainItemSelector: ".buying-combo-main",addToCartDelay: 200,trackingPrefix: (function () {var $targetElement = document.querySelector('#buying-combo');if (!!$targetElement) {return $targetElement.getAttribute('tracking-prefix');}return '';})()};var PersonalizationItem = function ($element) {this.itemNumber = $element.dataset.itemNumber;this.finalPrice = Number($element.dataset.finalPrice);this.webDescription = $element.dataset.webDescription;this.productImage = $element.dataset.productImage;this.isMapPrice = $element.dataset.isMapPrice;this.$element = $element;};var ArrowDirection = 1;var initSinglePersonalization = function () {if ($(_option.singleItemSelector).length > 0) {var $element = $(_option.personalizationSelector),$mainItemInfo = $element.find(_option.mainItemSelector)[0],data = {mainItem: new PersonalizationItem($mainItemInfo),selectedList: [],totalPrice: 0,removingItem: null,targetElement: $(_option.personalizationSelector + ' .buying-combo-info')[0],mapPriceMark: 0,mapPriceItem: ''};data.totalPrice = data.mainItem.finalPrice;var removeSingleTooltip = function (e) {$('[data-personalization-type="single"]').each(function () {if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {if ($('.popover-combo').length > 0 && $('.popover-combo').hasClass('in') && !$(e.target).hasClass('item-combo-remove')) {$(this).popover('toggle');}return;}});};$('body').on('click.tooltip', removeSingleTooltip);$(window).on('resize.tooltip', removeSingleTooltip);var mapPriceOnClick = function (e) {var queryParam = '';Web.UI.Control.openWindow(mapprice2017 ? Web.UI.ResourceManager.Url.www('Product/MappingPrice2017.aspx?Item=' + data.mapPriceParam) : Web.UI.ResourceManager.Url.www('Product/MappingPrice2012.aspx?Item=' + data.mapPriceParam),'_blank', 605, 800, 0, 0);};var update = function (data) {data.mapPriceMark = 0;if (data.mainItem.isMapPrice === "NOMAPPrice" || data.mainItem.isMapPrice === "MAPPrice") {data.selectedList.map(function (item) {if (item.isMapPrice === "MAPPrice" && data.mapPriceMark !== 2) {data.mapPriceMark = 1;} else if (item.isMapPrice === "SecureCheckoutMAP") {data.mapPriceMark = 2;if (data.mapPriceItem === '') {data.mapPriceItem = item.itemNumber;}}});}if (data.mainItem.isMapPrice === "MAPPrice" && data.mapPriceMark != 2) {data.mapPriceMark = 1;} else if (data.mainItem.isMapPrice === "SecureCheckoutMAP") {data.mapPriceMark = 2;data.mapPriceItem = data.mainItem.itemNumber;}var $element = document.createElement('div');$element.className = 'buying-combo-action';$element.appendChild(personalizationDOMBuilder.createComboQty(data));$element.appendChild(personalizationDOMBuilder.createPrice(data, false));$element.appendChild(personalizationDOMBuilder.createComboCta(data));$(data.targetElement).find('.buying-combo-action').remove();$($element).find('.buying-combo-qty[data-personalization-type="single"]').popover({html: true,content: function () {return $(this).find('.combo-item-details')[0];},element: "element",template: '<div class="popover popover-combo"><div class="popover-arrow"></div><h3 class="popover-title"></h3><div class="popover-content popover-body"></div></div>'});data.targetElement.appendChild($element);if ($('.popover-combo').length > 0) {$('.popover-combo').remove();$('.buying-combo-qty').popover("show");return false;}};var itemSelected = function (item) {data.selectedList.push(item);data.totalPrice += item.finalPrice;update(data);};var itemUnselected = function (itemNumber) {var removingItem = itemNumber;data.selectedList = data.selectedList.filter(function (item) {if (item.itemNumber === removingItem) {item.$element.checked = false;data.totalPrice -= item.finalPrice;}return item.itemNumber !== removingItem;});update(data);};var personalizationDOMBuilder = {createPrice: function (data, isPopup) {var $element = document.createElement('div'),moneyDigital = data.totalPrice.toFixed(2).split('.'),currency = '$',extraCurrentText = isPopup ? "Total:" : "",ulExtraClassName = isPopup ? " combo-item-price" : "",divClassName = isPopup ? "item-combo-price item-combo-price-single" : "buying-combo-total";$element.className = divClassName;if (data.mapPriceMark > 0) {var mapPriceText, mapPriceTitle = "Why we can't show the price";if (data.mapPriceMark === 1) {mapPriceText = "See price in cart";if (mapprice2017) {mapPriceTitle = "Add to cart to see price";}data.mapPriceParam = data.mainItem.itemNumber;if (data.selectedList.length > 0) {data.mapPriceParam += "&ItemList=";data.selectedList.map(function (obj) {data.mapPriceParam += ',' + obj.itemNumber;});}data.mapPriceParam += "&type=items";} else if (data.mapPriceMark === 2) {if (mapprice2017) {mapPriceTitle = "Login to see price";}mapPriceText = "Request Price";data.mapPriceParam = data.mapPriceItem;}$element.innerHTML = "<ul class=\"price" + ulExtraClassName + " is-map\">"+ "<li class=\"price-map\">"+ "<div class=\"pull-right\">"+ "<a class=\"priceAction\" "+ "herf=\"javascript:void(0)\""+ " title=\"" + mapPriceTitle + "\""+ " " + _option.trackingPrefix + "-events=\"A\""+ " " + _option.trackingPrefix + "-e-var78=\"Personalization - " + mapPriceText + ":" + data.mainItem.itemNumber + "\""+ ">"+ mapPriceText+ "</a>"+ "</div>"+ extraCurrentText+ "</li>"+ "<li class=\"price-current\"></li>"+ "<li class=\"price-save\"></li>"+ "<li class=\"price-note\"></li>"+ "<li class=\"price-ship\"></li>"+ "</ul>";if (mapprice2017) {if (data.mapPriceMark === 1) {$element.getElementsByClassName('priceAction')[0].addEventListener('click', function () {var sb = new Sys.Text.StringBuilder();var wces = Web.Config.Environment.SSLPage;sb.append(wces.AddTocart);sb.append("?Submit=ADD");sb.append("&ItemList=");sb.append(data.mainItem.itemNumber);data.selectedList.map(function (obj) {sb.append(",");sb.append(obj.itemNumber);});setTimeout(function () {window.location.href = sb.toString();}, _option.addToCartDelay);});}if (data.mapPriceMark === 2) {$element.getElementsByClassName('priceAction')[0].addEventListener('click', mapPriceOnClick);}} else {$element.getElementsByClassName('priceAction')[0].addEventListener('click', mapPriceOnClick);}} else {$element.innerHTML = "<ul class=\"price" + ulExtraClassName + "\">"+ "<li class=\"price-map\"></li>"+ "<li class=\"price-current\">"+ "<div class=\"pull-right\">"+ currency+ "<strong>" + Number(moneyDigital[0]).toLocaleString() + "</strong>"+ "<sup>." + moneyDigital[1] + "</sup>"+ "</div >"+ extraCurrentText+ "</li>"+ "</ul>";}return $element;},createItemCombo: function (item, selected) {var itemDetailLink = Web.UI.ResourceManager.Url.www("/Product/Product.aspx?Item=") + item.itemNumber;var removeButton = selected ? "<i class=\"item-combo-remove fa fa-times\""+ " " + _option.trackingPrefix + "-events=\"A\""+ " " + _option.trackingPrefix + "-e-var78=\"Personalization - Single Cart Remove:"+ item.itemNumber+ "\"></i>" : "";var $element = document.createElement('div');$element.className = 'items-combo';$element.dataset.itemNumber = item.itemNumber;$element.innerHTML = removeButton+ "<div class=\"item-combo-img\">"+ "<a href=\"" + itemDetailLink + "\">"+ "<img src=\"" + item.productImage + "\" alt=\"" + item.webDescription + "\">"+ "</a>"+ "</div>"+ "<div class=\"item-combo-desc\">"+ "<a href=\"" + itemDetailLink + "\">"+ item.webDescription+ "</a>"+ "</div>";if (selected) {$element.firstChild.onclick = function (event) {var $element = event.target.parentElement,itemNumber = $element.dataset.itemNumber;$element.remove();itemUnselected(itemNumber);event.preventDefault();return false;}}return $element;},createComboQty: function (data) {var $element = document.createElement('div');$element.className = 'buying-combo-qty';$element.dataset.personalizationType = "single";$element.dataset.toggle = "popover";$element.dataset.placement = "left";$element.dataset.container = "body";$element.dataset.originalTitle = data.selectedList.length + " Selected Items";$element.setAttribute(_option.trackingPrefix + "-events", "A");$element.setAttribute(_option.trackingPrefix + "-e-var78", "Personalization - View Selected Items");$element.innerHTML = "<a href=\"javascript:void(0)\">"+ "<strong>" + data.selectedList.length + "</strong>"+ " Selected Items"+ "</a>";var $comboDetail = document.createElement('div'),$comboList = document.createElement('div');$comboDetail.className = 'combo-item-details';$comboList.className = 'item-combo-list';$comboList.appendChild(personalizationDOMBuilder.createItemCombo(data.mainItem));data.selectedList.map(function (item) {$comboList.appendChild(personalizationDOMBuilder.createItemCombo(item, true));});var moneyDigital = data.totalPrice.toFixed(2).split('.');var $price = personalizationDOMBuilder.createPrice(data, true);$comboDetail.appendChild($comboList);$comboDetail.appendChild($price);$element.appendChild($comboDetail);return $element;},createComboCta: function (data) {var $element = document.createElement('div');$element.className = 'buying-combo-cta';$element.setAttribute(_option.trackingPrefix + "-events",  "A");$element.setAttribute(_option.trackingPrefix + "-e-var78", "Personalization - Add Selected To Cart");$element.innerHTML = "<button type=\"button\" class=\"btn btn-primary\">Add Selected to Cart <i class=\"fa fa-caret-right\"></i></button>";$element.addEventListener('click', function () {var sb = new Sys.Text.StringBuilder();var wces = Web.Config.Environment.SSLPage;sb.append(wces.AddTocart);sb.append("?Submit=ADD");sb.append("&ItemList=");sb.append(data.mainItem.itemNumber);data.selectedList.map(function (obj) {sb.append(",");sb.append(obj.itemNumber);});setTimeout(function () {window.location.href = sb.toString();}, _option.addToCartDelay);});return $element;}};$element.find(_option.singleItemSelector + ' .combo-item input').change(function (event) {var $element = event.target,tmpItem = new PersonalizationItem($element);if (event.target.checked) {itemSelected(tmpItem);} else {itemUnselected(tmpItem.itemNumber);}});update(data);}};var setSwiperLoopButton = function (box, swiper) {var fixedBullets = 0,lastPage = Math.floor(swiper.slides.length / 4);var $box = $(box);if ($box.find('.fa-angle-left').hasClass('swiper-button-disabled')) {$box.find('.fa-angle-left.swiper-button-disabled').one('click', function () {swiper._slideTo(swiper.slidesGrid.length);});} else {$box.find('.fa-angle-left').unbind('click');}if ($box.find('.fa-angle-right').hasClass('swiper-button-disabled')) {$box.find('.fa-angle-right.swiper-button-disabled').one('click', function () {swiper._slideTo(0);});} else {$box.find('.fa-angle-right').unbind('click');}};var initComboProduct = function () {if ($(_option.comboItemSelector).length > 0) {$('[data-personalization-type="combo"]').popover({html: true,content: function () {return $(this).parent().find('.combo-item-details').html();},element: "element",template: '<div class="popover popover-combo"><div class="popover-arrow"></div><h3 class="popover-title"></h3><div class="popover-content popover-body"></div></div>',});$("#buying-combo-2 .combo-item-img").on('click', function (event) {this.nextElementSibling.click();event.preventDefault();NEG.run(function (require) {jQuery('.popover.popover-combo.fade.right.in .combo-map-popup').attr("data-popup-loaded", "");var popup = require('Biz.Common.Popup');popup('.combo-map-popup', { icon: 'info' });});return false;});$("#buying-combo-2 .combo-item-desc").on('click', function (event) {event.preventDefault();NEG.run(function (require) {jQuery('.popover.popover-combo.fade.right.in .combo-map-popup').attr("data-popup-loaded", "");var popup = require('Biz.Common.Popup');popup('.combo-map-popup', { icon: 'info' });});});var removeComboTooltip = function (e) {$('[data-personalization-type="combo"]').each(function () {if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {if ($(this).data('bs.popover').tip().hasClass('in')) {if (jQuery("#modal1").length > 0 && jQuery("#modal1")[0].style.display == "block") {return;}$(this).popover('toggle');}return;}});};$('body').on('click.combo.tooltip', removeComboTooltip);$(window).on('resize.combo.tooltip', removeComboTooltip);}};var initSwiper = function () {if ($(_option.singleItemSelector + ' .combo-item-cell').length > 4) {var singleSwiper = new Swiper(_option.singleItemSelector + ' .swiper-container', {nextButton: _option.singleItemSelector + ' .fa-angle-right',prevButton: _option.singleItemSelector + ' .fa-angle-left',slidesPerView: 4,slidesPerGroup: 4,preventClicks: false,slideClass: 'combo-item-cell',onInit: function (swiper) {setSwiperLoopButton(_option.singleItemSelector, swiper);},onSlideChangeStart: function () {this.preventClicks = true;},onSlideChangeEnd: function (swiper) {this.preventClicks = false;setSwiperLoopButton(_option.singleItemSelector, swiper);sendSendCatalyst(swiper, false);}});} else {$(_option.singleItemSelector + ' .fa-angle-right, ' + _option.singleItemSelector + ' .fa-angle-left').hide();}if ($(_option.comboItemSelector + ' .combo-item-cell').length > 4) {var comboSwiper = new Swiper(_option.comboItemSelector + ' .swiper-container', {nextButton: _option.comboItemSelector +' .fa-angle-right',prevButton: _option.comboItemSelector + ' .fa-angle-left',slidesPerView: 4,slidesPerGroup: 4,preventClicks: false,slideClass: 'combo-item-cell',onInit: function (swiper) {setSwiperLoopButton(_option.comboItemSelector, swiper);},onSlideChangeStart: function () {this.preventClicks = true;},onSlideChangeEnd: function (swiper) {this.preventClicks = false;setSwiperLoopButton(_option.comboItemSelector, swiper);sendSendCatalyst(swiper, true);}});} else {$(_option.comboItemSelector + ' .fa-angle-right, ' + _option.comboItemSelector + ' .fa-angle-left').hide();}};var initSwtichTab = function () {$(_option.personalizationSelector + ' .tab-nav ul').children('li').click(function (e) {var $this = $(this);$this.parent().children('li').removeClass('is-active');var _n = $this.addClass('is-active').index();var $content = $this.parents('.tab-nav').siblings('.tab-pane').hide().eq(_n).show();var cells = $content.find('.combo-item-cell');var isCurrentSlideItemNeedSent = false;var currentCount = cells.length > 4 ? 4 : cells.length;for (var i = 0; i < currentCount; i++) {var tmp = sendData(cells[i]);if (!tmp) {isCurrentSlideItemNeedSent = true;}}if (cells.length > 4) {var siteCatalystParam = cells[0].dataset.siteCatalyst;if (siteCatalystParam) {var coreMetricsCategory = getcoreMetricsCategory(siteCatalystParam);var item = undefined;if ($(_option.singleItemSelector + ' .combo-item-cell').length > 4) {item = getPrimaryitem(false);} else if ($(_option.comboItemSelector + ' .combo-item-cell').length > 4) {item = getPrimaryitem(true);}if (item && coreMetricsCategory && isCurrentSlideItemNeedSent) {sendArrowToCache(item, 1, true, coreMetricsCategory);}}}Biz.Common.SiteCatalyst.sendCache("list1", "dynamic recommendation impression");}).eq(0).click();};var initDeactivedItemSwiper = function () {var mySwiper = new Swiper('#PersSimilarItem .swiper-container', {nextButton: '.arrow-right',prevButton: '.arrow-left',slideClass: 'swiper-slide',pagination: '.paginationid1',paginationClickable: true,loop: true,preventClicks: false,onInit: function () {var $box = jQuery("#PersSimilarItem");if ($box.find('.swiper-pagination-bullet').length <= 1) {$box.find('.pagination.paginationid1').attr('style', 'display:none');$box.find('.swiper-btns').attr('style', 'display:none');}$(document).ready(function () { Biz.Common.SiteCatalyst.sendCache("list1", "dynamic recommendation impression"); });},onSlideChangeStart: function () {this.preventClicks = true;},onSlideChangeEnd: function () {this.preventClicks = false;}});};var sendArrowToCache = function(item, slideIndex, isImpression, coreMetricsCategory) {eval("Biz.Common.SiteCatalyst.sendToCache({ 'list1': '-_--_--_-" + item + "-_--_-MoreArrowButton_" + slideIndex + "-_-Pers_" + coreMetricsCategory + (isImpression ? "_I_Imp" : "") + "-_--_-'+new Date().toISOString()+'-_-'})");};var getPrimaryitem = function(isCombo) {var arrow = isCombo ? $('#maywesuggest_arrow_combo') : $('#maywesuggest_arrow_single');if (!arrow) return undefined;var siteCatalystParam = arrow[0].value;return siteCatalystParam;};var getcoreMetricsCategory = function(firstItemCatalyst) {var regexp = /(?:-_-Pers_)(.*?)(?:_(I|M)_)/;return regexp.exec(firstItemCatalyst)[1];};var sendSendCatalyst = function (swiper, isCombo) {var activeIndex = swiper.activeIndex;var isCurrentSlideItemNeedSent = false;var currentSlideIndex = Math.ceil(activeIndex / 4) + 1;var item = getPrimaryitem(isCombo);var slidesCount = Math.ceil(swiper.slides.length / 4);var rightSlideIndex = currentSlideIndex + 1 > slidesCount ? 1 : currentSlideIndex + 1;var leftSlideIndex = currentSlideIndex - 1 <= 0 ? slidesCount : currentSlideIndex - 1;for (var i = activeIndex; i < activeIndex + 4; i++) {var tmp = sendData(swiper.slides[i]);if (!tmp) {isCurrentSlideItemNeedSent = true;}}if (activeIndex >= 0) {var siteCatalystParam = swiper.slides[activeIndex].dataset.siteCatalyst;if (siteCatalystParam) {var coreMetricsCategory = getcoreMetricsCategory(siteCatalystParam);if (item && coreMetricsCategory) {if (isCurrentSlideItemNeedSent) {sendArrowToCache(item, currentSlideIndex, true, coreMetricsCategory);}if (ArrowDirection) {sendArrowToCache(item, leftSlideIndex, false, coreMetricsCategory);} else {sendArrowToCache(item, rightSlideIndex, false, coreMetricsCategory);}}}}Biz.Common.SiteCatalyst.sendCache("list1", "dynamic recommendation impression");};var sendData = function ($container) {var sentFlag = $container.dataset.sent,siteCatalystParam = $container.dataset.siteCatalyst;if (typeof sentFlag === 'undefined') {$container.dataset.sent = true;if (typeof siteCatalystParam !== 'undefined') {eval(siteCatalystParam);return false;}}return true;};var nextSlide = function(direction) {ArrowDirection = direction;};return {initSingleProduct: initSinglePersonalization,initComboProduct: initComboProduct,initSwiper: initSwiper,initSwitchTab: initSwtichTab,initDeactivedItemSwiper: initDeactivedItemSwiper,nextSlide: nextSlide};});